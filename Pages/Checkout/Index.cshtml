@page
@model BoutiqueElegance.Pages.Checkout.IndexModel

@{
    ViewData["Title"] = "Paiement";
}

<div class="container">
    <!-- Titre de la page -->
    <div class="checkout-header">
        <h1 class="page-title">Finaliser votre commande</h1>
    </div>

    <!-- Checkout Layout principal -->
    <div class="checkout-wrapper">
        <!-- Résumé de la commande -->
        <div class="checkout-summary-section">
            <div class="summary-card">
                <h2 class="section-title">📋 Résumé de votre commande</h2>

                <!-- Items de la commande -->
                <div class="order-items-summary">
                    @foreach (var item in Model.Cart.Items)
                    {
                        <div class="summary-item">
                            <div class="item-info">
                                <h4 class="item-name">@item.Plat.Name</h4>
                                <p class="item-detail">Quantité: <strong>@item.Quantity</strong></p>
                            </div>
                            <div class="item-total">
                                <span class="item-amount">@(item.UnitPrice* item.Quantity) $</span>
                            </div>
                        </div>
                    }
                </div>

                <!-- Divider -->
                <div class="summary-divider"></div>

                <!-- Total final -->
                <div class="final-total">
                    <span class="total-label">Total à payer:</span>
                    <span class="total-amount">@Model.Total.ToString("0.00") $</span>
                </div>

                <!-- Retour au panier -->
                <a href="@Url.Page("/Cart/Index")" class="link-back">← Retour au panier</a>
            </div>
        </div>

        <!-- Formulaire de paiement -->
        <div class="checkout-payment-section">
            <div class="payment-card">
                <h2 class="section-title">💳 Informations de paiement</h2>

                <form id="payment-form" method="post" class="payment-form">
                    <!-- champ caché pour renvoyer l'id du PaymentIntent confirmé -->
                    <input type="hidden" id="paymentIntentId" name="paymentIntentId" />

                    <!-- Nom sur la carte -->
                    <div class="form-group">
                        <label for="cardHolder" class="form-label">Nom sur la carte</label>
                        <input type="text"
                               id="cardHolder"
                               asp-for="CardHolderName"
                               class="form-input"
                               placeholder="Jean Dupont"
                               required />
                    </div>

                    <!-- Email -->
                    <div class="form-group">
                        <label for="email" class="form-label">Adresse courriel</label>
                        <input type="email"
                               id="email"
                               asp-for="Email"
                               class="form-input"
                               placeholder="jean@exemple.com"
                               required />
                    </div>

                    <!-- Stripe Elements: carte -->
                    <div class="form-group">
                        <label class="form-label">Carte de crédit</label>
                        <div id="card-element" class="form-input stripe-card-element"></div>
                    </div>

                    <div id="card-errors" class="card-errors" role="alert"></div>

                    <!-- Bouton payer -->
                    <button type="submit" id="card-button" class="btn-pay">
                        Payer @Model.Total.ToString("0.00") $
                        <span class="btn-arrow">→</span>
                    </button>
                </form>

                <!-- Info Sécurité -->
                <div class="security-info">
                    <span class="security-icon">🔒</span>
                    <p>Vos données sont sécurisées par <strong>Stripe</strong></p>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://js.stripe.com/v3/"></script>
    <script>
        const stripe = Stripe("@Model.PublishableKey");
        const elements = stripe.elements();

        const cardElement = elements.create('card', {
            hidePostalCode: false
        });
        cardElement.mount('#card-element');

        const paymentForm = document.getElementById('payment-form');
        const cardButton = document.getElementById('card-button');
        const cardholderNameInput = document.getElementById('cardHolder');
        const cardErrors = document.getElementById('card-errors');
        const clientSecret = "@Model.ClientSecret";
        const paymentIntentIdInput = document.getElementById('paymentIntentId');

        paymentForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            cardButton.disabled = true;
            cardErrors.textContent = "";

            const { paymentIntent, error } = await stripe.confirmCardPayment(
                clientSecret,
                {
                    payment_method: {
                        card: cardElement,
                        billing_details: {
                            name: cardholderNameInput.value
                        }
                    }
                }
            );

            if (error) {
                cardErrors.textContent = error.message;
                cardButton.disabled = false;
            } else if (paymentIntent && paymentIntent.status === "succeeded") {
                // envoyer l'id du PaymentIntent au backend
                paymentIntentIdInput.value = paymentIntent.id;
                paymentForm.submit();
            } else {
                cardErrors.textContent = "Le paiement n'a pas pu être confirmé.";
                cardButton.disabled = false;
            }
        });
    </script>
}



